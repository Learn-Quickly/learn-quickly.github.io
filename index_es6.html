<html>
    <head>
        <meta charset="UTF-8">
        <title>Constructor</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <style type="text/css">
            textarea {
                border: none;
                resize: none;
                height: 100px;
                font-size: 20px;
                background-color: #efefef;
                border-radius: 10px;
            }

            textarea:focus {
                outline: none;
            }

            #json_place {
                height: 700px;
                font-size: 20px;
                background-color: #efefef;
                border-radius: 10px;
                padding: 20px;
            }

            #session_variants {
                overflow-y: hidden;
                padding-left: 0;
                font-size: 20px;
            }
            #session_variants:focus {
                outline: none;
            }
            #session_variants>option {
                text-align: center;
            }

            .variant {
                font-size: 20px;
                font-weight: 600;
            }

            .answer-variant {
                width: 100%;
            }

            .delete-button {
                width: 100%;
            }

        </style>
    </head>
    <body>
        <div class="container">
            <select class="col-3 mt-3 mb-3" name="choose_question" id="question_variants">
                <option value="1">1 Одиночный выбор</option>
                <option value="2">2 Множественный выбор</option>
                <option value="3">3 Соответствие</option>
                <option value="4">4 Ввод ответа текстом</option>
            </select>
            <div class="card" id="question_card">
                <div class="card-body">
                    <fieldset class="mt-3">
                        <div class="row">
                            <select class="col-2 ml-3" name="session_select" onclick="select_session();" id="session_variants" multiple="">
                                <option value="1">Сессия 1</option>
                                <option value="2">Сессия 2</option>
                                <option value="3">Сессия 3</option>
                                <option value="4">Сессия 4</option>
                                <option value="5">Сессия 5</option>
                            </select>
                            <textarea class="col-7 ml-3" name="question_text" id="question_text" placeholder="Ввведите текст вопроса" row="4"></textarea>
                            <button class="btn btn-primary col-2 ml-3" onclick="renderJson();">Преобразовать</button>
                        </div>
                        <div class="container mt-5" id="variative"></div>
                    </fieldset>
                </div>
            </div>
            <div class="card mt-5" id="json_card">
                <div class="card-body">
                    <div class="col-12" id="json_place">На данный момент работает только 1-ый тип вопросов</div>
                </div>
            </div>
        </div>
    </body>
    <script type="text/javascript">
        var alphabet = "АБВГҐДЕЄЖЗИІЇЙКЛМНОПРСТУФХЦЧШЩЬЮЯ";

        var question_type = document.getElementById("question_variants");

        var variative = document.getElementById("variative");

        var session_select = document.getElementById("session_variants");

        var question_textarea = document.getElementById('question_text');

        var json_place = document.getElementById('json_place');

        class OneChooseQuestion {
            type = 1;

            constructor(){
                this.sessions = [];
                this.question_div = document.createElement('div');
                this.question_header = htmlToElement(`<div class="row">
                                <h4 class="col-3">Варианты ответов</h4>
                                <div class="col-4"><button class="btn btn-success" onclick="firstTypeQuestion.add_variant();" id="add_one_choose_variant">Добавить вариант</button></div>
                            </div>`);
                this.variants_node = htmlToElement('<div class="container" id="variants"></div>');

                this.question_div.appendChild(this.question_header);
                this.question_div.appendChild(this.variants_node);
                this.variant_divs = {};
                this.variants_count = 0;
            }

            add_variant(){
                if (this.variants_count > 32){
                    return null;
                }
                let variant_name = alphabet[this.variants_count++];
                let uuid = uuidv4();
                let div = htmlToElement(`<div class="row mt-3">
                                                <input type="radio" name="true_answer" value="${uuid}" class="align-self-center mr-3 true_answer">
                                                <div class="align-self-center variant mr-3">${variant_name}</div>
                                                <div class="card col-11">
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <input class="answer-variant answer-variant-${uuid}" type="text" name="answer_text" placeholder="Введите вариант ответа">
                                                            </div>
                                                            <div class="ml-auto col-2">
                                                                <button type="button" class="btn btn-danger" onclick="firstTypeQuestion.deleteVariant('${uuid}')">Удалить</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`);
                this.variant_divs[uuid] = div;
                this.renderVariants();
            }

            deleteVariant(uuid){
                delete this.variant_divs[uuid];
                this.renderVariants();
            }

            getVariants(){
                let variants = {};
                for (let uuid in this.variant_divs) {
                    let div = this.variant_divs[uuid];
                    let input = div.getElementsByClassName(`answer-variant-${uuid}`)[0];
                    let variant_name = div.getElementsByClassName("variant")[0].innerHTML;

                    variants[variant_name] = input.value;
                }
                return variants;
            }

            getVariantNodes(){
                let nodes = [];
                let letter_counter = 0;
                for (let uuid in this.variant_divs) {
                    let div = this.variant_divs[uuid];
                    div.getElementsByClassName("variant")[0].innerHTML = alphabet[letter_counter++];
                    nodes.push(div);
                    this.variant_divs[uuid] = div;
                }
                return nodes;
            }

            renderVariants(){
                let variants = this.getVariantNodes();
                this.variants_node.innerHTML = '';
                for (let div of variants) {
                    this.variants_node.appendChild(div);
                }
            }

            getAnswer(){
                let radios = this.variants_node.getElementsByClassName("true_answer");
                for (let radio of radios) {
                    if (radio.checked) {
                        let uuid = radio.value;
                        return this.variant_divs[uuid].getElementsByClassName("variant")[0].innerHTML;
                    }
                }
            }

            toJson(){
                let questionObject = {
                    "type": this.type,
                    "sessions": this.sessions,
                    "question_text": question_textarea.value.trim(),
                    "variants": this.getVariants(),
                    "answer": this.getAnswer(),
                }

                if (questionObject.sessions.length == 0){
                    return "Выберите одну или несколько сессий";
                }

                if (!questionObject.question_text){
                    return "Введите текст вопроса";
                }

                if (this.getVariantNodes().length < 2){
                    return "Добавьте минимум 2 варианта ответа";
                }

                for (let variant in questionObject.variants){
                    if (!questionObject.variants[variant]){
                        return `Вариант ${variant} пустой`;
                    }
                }

                if (!questionObject.answer){
                    return "Укажите правильный ответ";
                }

                return JSON.stringify(questionObject);
            }


        }

        var firstTypeQuestion = new OneChooseQuestion();

        variative.innerHTML = '';
        variative.appendChild(firstTypeQuestion.question_div);

        function select_session(){
            let question = getQuestionObject();

            question.sessions = getSessions();

        }

        function getQuestionObject(){
            let question;
            switch (parseInt(question_type.value)) {
                case 1:
                    question = firstTypeQuestion;
                    break;

                case 2:
                    question = firstTypeQuestion;
                    break;

                case 3:
                    question = firstTypeQuestion;
                    break;

                case 4:
                    question = firstTypeQuestion;
                    break;

            }

            return question;
        }

        function getSessions(){
            let sessions = [];

            for (let option of session_select.options) {
                if (option.selected) {
                    sessions.push(parseInt(option.value));
                }
            }
            return sessions;
        }

        function writeJson(jsonString){
            json_place.innerHTML = jsonString;
        }

        function renderJson(){
            writeJson(getQuestionObject().toJson());
        }

        function uuidv4() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        }

        function htmlToElement(html) {
            var template = document.createElement('template');
            html = html.trim(); // Never return a text node of whitespace as the result
            template.innerHTML = html;
            console.log(template.content.firstChild);
            return template.content.firstChild;
        }

    </script>
</html>
